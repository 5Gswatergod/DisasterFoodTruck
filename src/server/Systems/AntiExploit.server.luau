local RS  = game:GetService("ReplicatedStorage")
local SSS = game:GetService("ServerScriptService")

local Remotes = require(RS:WaitForChild("Shared"):WaitForChild("RemotesIndex"))
local SubmitOrder = Remotes.SubmitOrder
local MatchState  = Remotes.MatchState

local function getSystems()
	local sys = SSS:FindFirstChild("Systems")
	if not sys then
		local srv = SSS:FindFirstChild("Server")
		if srv then sys = srv:FindFirstChild("Systems") end
	end
	assert(sys, "[AntiExploit] 找不到 Systems")
	return sys
end

local Systems     = getSystems()
local PDModule    = Systems:WaitForChild("PlayerData")
local OSModule    = Systems:WaitForChild("OrderSystem")
local PlayerData  = require(PDModule)
local OrderSystem = require(OSModule)

print("[AntiExploit] PlayerData module:", PDModule:GetFullName(), "Ensure?", (PlayerData.Ensure ~= nil))

local last = {}

local Players = game:GetService("Players")
Players.PlayerRemoving:Connect(function(plr)
	last[plr] = nil
end)

SubmitOrder.OnServerEvent:Connect(function(player, payload)
	-- 節流
	local now = os.clock()
	if last[player] and now - last[player] < 0.25 then return end
	last[player] = now

	if type(payload) ~= "table" or type(payload.id) ~= "string" then return end

	local ok, tip = OrderSystem:Submit(player, payload)
	if not ok then
		MatchState:FireClient(player, "ORDER_RESULT", { ok=false, id=payload.id })
		return
	end

	-- 取得/建立 profile（相容沒 Ensure 的舊版）
	local profile = (PlayerData.Ensure and PlayerData:Ensure(player)) or PlayerData:Get(player)
	local before  = (profile and profile.Cash) or 0

	-- 加錢（相容舊版）
	if PlayerData.AddCash then
		PlayerData:AddCash(player, tip or 0)
	elseif profile then
		profile.Cash = before + (tip or 0)
	end

	local after = (profile and profile.Cash) or (before + (tip or 0))

	-- 統計（防呆）
	if profile then
		profile.Stats = profile.Stats or {}
		profile.Stats.PlatesServed = (profile.Stats.PlatesServed or 0) + 1
	end

	print(("[AntiExploit] %s Cash: %d -> %d (+%d)"):format(player.Name, before, after, tip or 0))

	MatchState:FireClient(player, "ORDER_RESULT", {
		ok=true, id=payload.id, tip=tip or 0,
		cash=after, cashAfter=after, cashBefore=before
	})

end)

print("[AntiExploit] OK。Systems 路徑 = " .. Systems:GetFullName())