local RS  = game:GetService("ReplicatedStorage")
local SSS = game:GetService("ServerScriptService")
local Players = game:GetService("Players")

local RemotesFolder = RS:WaitForChild("Remotes")
local SubmitOrder   = RemotesFolder:WaitForChild("SubmitOrder")  -- RemoteEvent
local MatchState    = RemotesFolder:WaitForChild("MatchState")   -- RemoteEvent

local function getSystems()
	local sys = SSS:FindFirstChild("Systems")
	if not sys then
		local srv = SSS:FindFirstChild("Server")
		if srv then sys = srv:FindFirstChild("Systems") end
	end
	assert(sys, "[AntiExploit] æ‰¾ä¸åˆ° Systems è³‡æ–™å¤¾ï¼ˆSSS/Systems æˆ– SSS/Server/Systemsï¼‰")
	return sys
end

local Systems     = getSystems()
local OrderSystem = require(Systems:WaitForChild("OrderSystem"))
local PlayerData  = require(Systems:WaitForChild("PlayerData"))

local last = {}

SubmitOrder.OnServerEvent:Connect(function(player, payload)
	-- 250ms ç¯€æµ
	local now = os.clock()
	last[player] = last[player] or 0
	if now - last[player] < 0.25 then return end
	last[player] = now

	if type(payload) ~= "table" or type(payload.id) ~= "string" then return end

	local ok, tip = OrderSystem:Submit(player, payload)
	if ok then
		-- ğŸ”’ ç¢ºä¿ä¸€å®šæœ‰ Profile
		local profile = PlayerData:Ensure(player)
		local before  = (profile and profile.Cash) or 0

		-- åŠ éŒ¢ï¼ˆç¾åœ¨ä¸€å®šæœƒæˆåŠŸï¼‰
		if PlayerData.AddCash then
			PlayerData:AddCash(player, tip or 0)
		else
			profile.Cash = before + (tip or 0)
		end
		local after = profile.Cash or (before + (tip or 0))

		-- çµ±è¨ˆ
		profile.Stats = profile.Stats or {}
		profile.Stats.PlatesServed = (profile.Stats.PlatesServed or 0) + 1

		print(("[AntiExploit] %s Cash: %d -> %d (+%d)")
			:format(player.Name, before, after, tip or 0))

		MatchState:FireClient(player, "ORDER_RESULT", {
			ok         = true,
			id         = payload.id,
			tip        = tip or 0,
			cash       = after,
			cashAfter  = after,
			cashBefore = before,
		})

		--ï¼ˆå¯é¸ï¼‰è‡ªå‹•æ´¾ä¸‹ä¸€å¼µæ–¹ä¾¿é€£æ¸¬
		task.delay(2, function()
			local p = PlayerData:Ensure(player)
			OrderSystem:SpawnOrder(player, p, "Beach")
		end)
	else
		MatchState:FireClient(player, "ORDER_RESULT", { ok = false, id = payload.id })
	end
end)


print("[AntiExploit] OKã€‚Systems è·¯å¾‘ = " .. Systems:GetFullName())
