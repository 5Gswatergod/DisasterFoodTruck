local Players = game:GetService("Players")
local RS = game:GetService("ReplicatedStorage")
local Remotes = RS:WaitForChild("Remotes")
local MatchState = Remotes:WaitForChild("MatchState") :: RemoteEvent
local SubmitOrder = Remotes:WaitForChild("SubmitOrder") :: RemoteEvent

local player = Players.LocalPlayer
local Gui = Instance.new("ScreenGui"); Gui.Name = "OrdersMini"; Gui.ResetOnSpawn = false; Gui.Parent = player:WaitForChild("PlayerGui")

local frame = Instance.new("Frame")
frame.Size = UDim2.fromOffset(340, 200)
frame.Position = UDim2.fromOffset(20, 80)
frame.BackgroundTransparency = 0.2
frame.BackgroundColor3 = Color3.fromRGB(25,25,25)
frame.BorderSizePixel = 0
frame.Parent = Gui

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -16, 0, 28)
title.Position = UDim2.fromOffset(8, 6)
title.TextXAlignment = Enum.TextXAlignment.Left
title.Text = "ğŸ§¾ è¨‚å–®"
title.TextColor3 = Color3.fromRGB(255,255,255)
title.BackgroundTransparency = 1
title.Parent = frame

local body = Instance.new("TextLabel")
body.Size = UDim2.new(1, -16, 0, 96)
body.Position = UDim2.fromOffset(8, 36)
body.TextXAlignment = Enum.TextXAlignment.Left
body.TextYAlignment = Enum.TextYAlignment.Top
body.TextWrapped = true
body.TextColor3 = Color3.fromRGB(220,220,220)
body.BackgroundTransparency = 1
body.Font = Enum.Font.Gotham
body.TextSize = 14
body.Text = "ç­‰å¾…è¨‚å–®â€¦"
body.Parent = frame

local btn = Instance.new("TextButton")
btn.Size = UDim2.fromOffset(150, 36)
btn.Position = UDim2.fromOffset(8, 140)
btn.Text = "âœ… äº¤ä»˜ï¼ˆæ¸¬è©¦ï¼‰"
btn.TextColor3 = Color3.fromRGB(15,15,15)
btn.BackgroundColor3 = Color3.fromRGB(255,221,87)
btn.AutoButtonColor = true
btn.Parent = frame
btn.Active = false

-- å³ä¸Š Cash
local cashLabel = Instance.new("TextLabel")
cashLabel.Size = UDim2.fromOffset(220, 34)
cashLabel.Position = UDim2.new(1, -240, 0, 20)
cashLabel.BackgroundTransparency = 0.2
cashLabel.BackgroundColor3 = Color3.fromRGB(25,25,25)
cashLabel.BorderSizePixel = 0
cashLabel.TextColor3 = Color3.fromRGB(255,255,255)
cashLabel.TextXAlignment = Enum.TextXAlignment.Center
cashLabel.Font = Enum.Font.GothamSemibold
cashLabel.TextSize = 16
cashLabel.Text = "ğŸ’° Cash: 0"
cashLabel.Parent = Gui

local current, busy
local lastCash = 0

local function setIdle()
	current = nil
	busy = false
	btn.Active = false
	btn.Text = "âœ… äº¤ä»˜ï¼ˆæ¸¬è©¦ï¼‰"
	body.Text = "ç­‰å¾…è¨‚å–®â€¦"
end

-- Debugï¼šåˆ—ç¾æœ‰ Remotes
task.defer(function()
	for _,c in ipairs(Remotes:GetChildren()) do
		print("[Remotes child]", c.Name, c.ClassName)
	end
end)

MatchState.OnClientEvent:Connect(function(kind, payload)
	if kind == "NEW_ORDER" then
		current = payload
		local r = payload.recipe
		body.Text = string.format("èœå“ï¼š%s\néœ€æ±‚ï¼š%s\nå°è²»åŸºç¤ï¼š%d",
			r.name or r.id, table.concat(r.ingredients, ", "), r.tipBase or 0)
		btn.Active = true

	elseif kind == "ORDER_RESULT" then
		print("[ORDER_RESULT] ok=", payload and payload.ok, " before=", payload and payload.cashBefore, " after=", payload and payload.cashAfter, " tip=", payload and payload.tip)

		if payload.ok then
			-- ä»¥ after å„ªå…ˆï¼Œå…¶æ¬¡ç”¨ before+tip
			local newCash = tonumber(payload.cashAfter)
			if not newCash and tonumber(payload.cashBefore) and tonumber(payload.tip) then
				newCash = tonumber(payload.cashBefore) + tonumber(payload.tip)
			end
			if newCash then
				lastCash = newCash
				cashLabel.Text = ("ğŸ’° Cash: %d"):format(newCash)
			end

			body.Text = (body.Text .. ("\n\nâœ… äº¤ä»˜æˆåŠŸï¼å°è²» +%d"):format(payload.tip or 0))
			-- æ¸…æ‰ç›®å‰è¨‚å–®ï¼Œç­‰å¾…ä¼ºæœç«¯ 2 ç§’å¾Œæ´¾æ–°å–®
			setIdle()
			busy = false
		else
			body.Text = (body.Text .. "\n\nâŒ é©—è­‰å¤±æ•—")
			busy = false
			btn.Active = true
			btn.Text = "âœ… é‡è©¦äº¤ä»˜"
		end
	end
end)

btn.MouseButton1Click:Connect(function()
	if busy or not current then return end
	busy = true
	btn.Active = false
	btn.Text = "â€¦äº¤ä»˜ä¸­"
	SubmitOrder:FireServer({ id = current.id, ingredients = current.recipe.ingredients })
end)

setIdle()
